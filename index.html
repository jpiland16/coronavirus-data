<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>webQuery Data Analysis</title>
		
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <script language="javascript" type="text/javascript">
			
			var JHUdata = [];
			var coronaData = [];
			var countyByState = {};
			var dayLabels = [];
			var myLineChart;
			var currentlyShowing = []; //For COUNTIES
			var currentlyShowingStates = [];
			var currentType = "county";
			var hueMultiplier = 130.1;
			var maxToShow = 20;
			var reverse = 1;
			var stateData = {};
			
			var preset = false;
			
			var originalController = Chart.controllers.line;
			Chart.controllers.line = Chart.controllers.line.extend({
				draw: function() {
			    	originalController.prototype.draw.call(this, arguments);
			    	drawLabels(this);
			  	}
			});
			
			var paramString = window.location.href.match(/(?<=\?).+/);
			var params = [];
			if (paramString) { params = paramString.toString().split("&"); }
			var parameterObject = {};
			for(var i = 0; i < params.length; i++) {
				var paramSplit = params[i].split("=");
				if(paramSplit[1]) {
					parameterObject[paramSplit[0]] = paramSplit[1];
				}
			}
			
			function getParam(name) {
				if(parameterObject && parameterObject[name]) {
					return parameterObject[name];
				} else {
					return undefined;	
				}
			}
			
			
			
            function print(p) {               
                var d = new Date();
                var minute = d.getMinutes();
                if(minute < 10) {
                    minute = "0" + minute;
                }	
                var sec = d.getSeconds();
                if(sec < 10) {
                    sec = "0" + sec;    
                }	
                var msec = d.getMilliseconds();
                if(msec < 10) {
                    msec = "00" + msec;
                }
                if(msec < 100 && msec > 9) {
                    msec = "0" + msec;
                }
                console.log((d.getMonth() + 1) + "/" + (d.getDate()) + "/" + (d.getYear() + 1900) + " " + d.getHours() + ":" + minute + ":" + sec + "." + msec + " | " + p);
            }
            
			function stat(info) {
				document.getElementById("status").value = info;
				print(info);	
			}
		
		// Use CORS-Anywhere to scrape a web page //
			
		var cors_api_url = 'https://cors-anywhere.herokuapp.com/';
  		function doCORSRequest(options, printResult) {
   		var x = new XMLHttpRequest();
    		x.open(options.method, cors_api_url + options.url);
   			x.onload = x.onerror = function() { printResult(
    	   		//options.method + ' ' + options.url + '\n' +
       			//x.status + ' ' + x.statusText + '\n\n' +
       			(x.responseText || '')
      		); };
    		if (/^POST/i.test(options.method)) {
      			x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    		}
    		x.send(options.data);
  		}

  		function getData(url, functionWhenDone) {
			//stat("Attempting to retrieve data from " + url);
      		doCORSRequest({
        		method: 'GET',
        		url: url,
      		}, function printResult(result) {
        		functionWhenDone(result);
      		});	  
  		}
  
			function resolveCommas(array) { //Resolves commas for ONE LINE of a CSV file
				showRegOut("Preparing to resolve commas in this array: " + array);
				var newArray = new Array();
				var currentIndex = 0;
				var searchingForMatch = false;
				for (var i = 0; i < array.length; i++) {
					if (array[i]) {
						var currentString = array[i];
						if (currentString.search(/^"(?!")|^"""/) != -1) { //If #1  --  CHECK THE REGEX 
							//newArray[currentIndex] = "";
							showRegOut("The current string {" + currentString + "} and array index " + i + " begins with a double quote. Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
							currentString = currentString.substr(1);
							if (currentString.search(/(?<!")"$|"""$/) != -1) { //If #1a
								showRegOut("The current string {" + currentString + "} and array index " + i + " also ends with a double quote. Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
								currentString = currentString.substr(0,(currentString.length - 1));
								newArray[currentIndex] = currentString.replace(/""/g,'"');
								currentIndex += 1;
							} else {
								newArray[currentIndex] = currentString.replace(/""/g,'"');
								showRegOut("The current string {" + currentString + "} and array index " + i + " does not have the end quote. Searching for a match... Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
								searchingForMatch = true;
							}							
						} else if(searchingForMatch) { //If #1b
							if (currentString.search(/(?<!")"$|"""$/) != -1) { //If #1ba
								showRegOut("The current string {" + currentString + "} and array index " + i + " has the end quote. Stopping search... Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
								currentString = currentString.substr(0,(currentString.length - 1));
								newArray[currentIndex] = newArray[currentIndex] + "," + currentString.replace(/""/g,'"');
								searchingForMatch = false;
								currentIndex += 1;
							} else {
								showRegOut("The current string {" + currentString + "} and array index " + i + " does not have the end quote. Continuing the search... Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
								newArray[currentIndex] = newArray[currentIndex] + "," + currentString.replace(/""/g,'"');	
							}
						} else {
							showRegOut("The current string {" + currentString + "} and array index " + i + " is not being searched. Current array value for index " + currentIndex + " is " + newArray[currentIndex]);
							newArray[currentIndex] = currentString.replace(/""/g,'"');
							currentIndex += 1;
						}
					} else {
						currentIndex++;
					}
					showRegOut(newArray);
				}
				
				return newArray;
			}
			
			function showRegOut(text) {
				//print(text);	
			}
		
			
			function bodyLoaded() {
				
				if(getParam("preset") == "true") {
					preset = true;
				}
				
				if(getParam("by") == "state") {
					currentType = "state";
					document.getElementById("stateCounty").value = "state";
					SCDisable();
				}
				
				getData("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv", function dataLoaded(data) {
					if(data) {
						stat("Data downloaded. Analyzing...");
						var currentState = ""; //(As in North Carolina)
						JHUdata = data.split("\n");
						var length = JHUdata.length - 1; //last line is blank
						length = 3148; //Actually - line 3148 is the last "county" listing.
						for(var i = 0; i < length; i++) {
							coronaData[i] = [];
							coronaData[i] = JHUdata[i].split(",")
							coronaData[i] = resolveCommas(coronaData[i]);
							
							if(i > 0) {
								var locationInfo = coronaData[i][10].split(",");
								if(locationInfo[1][0] == " ") {
									locationInfo[1] = locationInfo[1].substring(1);	
								}
								
								var currentCounty = locationInfo[0];
								
								if(locationInfo[1] != currentState) {
									currentState = locationInfo[1];
									countyByState[currentState] = {};
								}
								
								countyByState[currentState][currentCounty] = coronaData[i].slice(11);
								
								if(!stateData[currentState]) {
									stateData[currentState] = [];
								}
								
								for(var j = 0; j < countyByState[currentState][currentCounty].length; j++) {
									var addCountyCases = Number(countyByState[currentState][currentCounty][j]);
									stateData[currentState][j] = 
 stateData[currentState][j] ? Number(stateData[currentState][j]) + addCountyCases : addCountyCases;
								}
								
							}
						}
						var lastIndex = coronaData[0].length - 1;
						var mostRecentUpdate = coronaData[0][lastIndex];
						stat("Done importing " + (length - 1) + " counties. Last update " + mostRecentUpdate + ".");
						dayLabels = coronaData[0].slice(11);
						populateSelects();
						
						
						
					} else {
						stat("Data import failed.");	
					}
				} );
			}
			
			function populateSelects() {
				var stateSelect = document.getElementById("state");
				deleteChildren("state");
				var disabledOption = document.createElement("option");
				disabledOption.innerText = "Choose a state...";
				disabledOption.selected = true;
				disabledOption.disabled = true;
				stateSelect.appendChild(disabledOption);
				
				
				document.getElementById("state").disabled = false;
				var stateNames = Object.getOwnPropertyNames(countyByState);
				for (var i = 0; i < stateNames.length; i++) {
					
					var stateOption = document.createElement("option");
					stateOption.innerText = stateNames[i];
					stateOption.value = stateNames[i];
					stateSelect.appendChild(stateOption);
									
				}
				
				if(preset) {
					document.getElementById("state").value = "North Carolina";
					changeState();
				}
			}
			
			function showInfo(text) {
				var output = document.getElementById("output");
				var label = document.createElement("label");
				label.innerText = text;
				output.insertBefore(label,output.firstChild);
				output.insertBefore(document.createElement("br"),output.firstChild);
				output.insertBefore(document.createElement("br"),output.firstChild);
			}
			
			function changeState() {
				if(currentType == "state") {
					pushState(document.getElementById("state").value);
					redrawChart();
				} else {
					document.getElementById("county").disabled = false;
				}
				deleteChildren("county");
				var disabledOption = document.createElement("option");
				var countySelect = document.getElementById("county");
				disabledOption.innerText = "Choose a county...";
				disabledOption.selected = true;
				disabledOption.disabled = true;
				countySelect.appendChild(disabledOption);
				
				var selectedState = document.getElementById("state").value;
				
				var stateObject = countyByState[selectedState];
				var countyNames = Object.getOwnPropertyNames(stateObject);
				
				for (var i = 0; i < countyNames.length; i++) {
					
					var countyOption = document.createElement("option");
					countyOption.innerText = countyNames[i];
					countyOption.value = countyNames[i];
					countySelect.appendChild(countyOption);
									
				}
				
				if(preset) {
					document.getElementById("county").value = "Cumberland";	
					changeCounty();
					preset = false;
				}
				
			}
			
			function pushLine(county,state) {
				var hasMatch = false;
				for(var i = 0; i < currentlyShowing.length; i++) {
					if (currentlyShowing[i].county == county && currentlyShowing[i].state == state) {
						hasMatch = true;	
						break;
					}
				}
				
				if(!hasMatch) {
					currentlyShowing[currentlyShowing.length] = {
						county: county,
						state: state
					}
					
				}
				
			}
			
			function showLegend() {
				var array;
				deleteChildren("output");
				var outputSpace = document.getElementById("output");
				var headers = ["","","#","Location","Total","\u0394Today","%Growth","\u0394 (7d Avg)","%Growth (7d Avg)",""]
				var table = document.createElement("table");
				table.classList.add("myTable");
				var headerRow = document.createElement("tr");
				table.appendChild(headerRow);
				for(var j = 0; j < headers.length; j++) {
					var th = document.createElement("th");
					th.innerText = headers[j];
					headerRow.appendChild(th);
				}
				var arrayToUse = (currentType == "county") ? currentlyShowing : currentlyShowingStates;
				for(var i = 0; i < arrayToUse.length; i++) { 
					var label;
					var county; 
					var state;
					if(currentType == "county") {
						county = arrayToUse[i].county;
						state = arrayToUse[i].state;
						array = countyByState[state][county];
						label = county + ", " + state;
					} else {
						state = arrayToUse[i];	
						array = stateData[state];
						label = state;
					}
					
					var row = document.createElement("tr");
					table.appendChild(row);
					
					var td;
					
					td = document.createElement("td");
					var button = document.createElement("button");
					button.innerText = "Remove";
					if(currentType == "county") {
						button.setAttribute("onclick","removeLine('" + county + "','" + state + "')");
					} else {
						button.setAttribute("onclick","removeState('" + state + "')");
					}
					td.appendChild(button);
					row.appendChild(td);
					
					td = document.createElement("td");
					var button = document.createElement("button");
					var hue = Math.round((hueMultiplier * i) % 360);
					var color = document.createElement("button");
					color.style.backgroundColor = "hsla(" + hue + ",90%,39%,0.8)";
					color.disabled = true;
					color.classList.add("color");
					td.appendChild(color);
					row.appendChild(td);
					
					td = document.createElement("td");
					td.innerText = (i + 1);
					td.classList.add("right");
					row.appendChild(td);
					
					td = document.createElement("td");
					td.innerText = label;
					row.appendChild(td);
					
					
					var caseData = [];
					
					switch(document.getElementById("dataSelect").value) {
						case "DaysSince5":
							var startIndex = 0;
							for(var j = 0; j < array.length; j++) {
								startIndex = j;
								if(array[j] >= 5) {
									break;
								} 
							}
							caseData = array.slice(startIndex);
							break;
						case "All":
							caseData = array;
							break;
							
					}
					
					var totalCases = caseData[caseData.length - 1];
					
					td = document.createElement("td");
					td.innerText = totalCases;
					td.classList.add("right");
					row.appendChild(td);
					
					var yestCases = caseData[caseData.length - 2];
					yestCases = yestCases ? yestCases : 0;
					var newCases = totalCases - yestCases;
					var plusMinus = "+";
					if(newCases < 0) { plusMinus = ""; }
					
					td = document.createElement("td");
					td.innerText = plusMinus + newCases;
					td.classList.add("right");
					row.appendChild(td);
					
					var percGrowth = 0;
					if(yestCases > 0) { percGrowth = Math.round(newCases / yestCases * 100); }
					
					td = document.createElement("td");
					td.innerText = plusMinus + percGrowth + "%";
					td.classList.add("right");
					row.appendChild(td);
					
					var plusMinus2 = "+";
					var caseAvgData = get7DA(getDiffs(caseData));
					var caseAvgToday = caseAvgData[caseAvgData.length - 1];
					var percAvgData = get7DA(getPercs(caseData));
					var percAvgToday = percAvgData[percAvgData.length - 1];
					if(caseAvgToday < 0) { plusMinus2 = ""; }
					
					td = document.createElement("td");
					td.innerText = plusMinus2 + caseAvgToday + " /day";
					td.classList.add("right");
					row.appendChild(td);
					
					td = document.createElement("td");
					td.innerText = plusMinus2 + percAvgToday + "% /day";
					td.classList.add("right");
					row.appendChild(td);
					
					td = document.createElement("td");
					var btn = document.createElement("button");
					button.innerText = "Show all data";
					var onclick = (currentType == "county") ? "showAll('" + state + "','" + county + "')" : "showAll('" + state + "')";
					button.setAttribute("onclick",onclick);
					td.appendChild(button);
					row.appendChild(td);
					
					/*var div = document.createElement("div");
					div.classList.add("legend");
					var outputSpace = document.getElementById("output");
					var label = document.createElement("label");
					var label2 = document.createElement("label");
					var caseData = countyByState[state][county];
					var totalCases = caseData[caseData.length - 1];
					var yestCases = caseData[caseData.length - 2];
					var newCases = totalCases - yestCases;
					var percGrowth = 0;
					if(yestCases > 0) { percGrowth = Math.round(newCases / yestCases * 100); }
					var plusMinus = "+";
					if(newCases < 0) { plusMinus = ""; }
					var plusMinus2 = "+";
					label.innerText = " (" + (i + 1) + ") " + county + ", " + state + " ";
					label2.innerText = totalCases + " cases (" + plusMinus + newCases + " yesterday = " + plusMinus + percGrowth + "%)";
					label.classList.add("legendLabel");
					var button = document.createElement("button");
					button.innerText = "Remove";
					button.setAttribute("onclick","removeLine('" + county + "','" + state + "')");
					var hue = Math.round((hueMultiplier * i) % 360);
					var color = document.createElement("button");
					color.style.backgroundColor = "hsla(" + hue + ",90%,39%,0.8)";
					color.disabled = true;
					color.classList.add("color");
					outputSpace.appendChild(div);
					div.appendChild(button);
					div.appendChild(color);
					div.appendChild(label);
					div.appendChild(label2);*/
					
				}
				outputSpace.appendChild(table);
			}
			
			function drawLabels(t) {
				var ctx = document.getElementById("myChart").getContext("2d");
				ctx.save();
				ctx.font = Chart.helpers.fontString(15, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
				ctx.textBaseline = 'bottom'; 
			
				var chartInstance = t.chart;
				var datasets = chartInstance.config.data.datasets;
				var i = 0;
				datasets.forEach(function(ds, index) {
					var hue = Math.round((hueMultiplier * i) % 360);
					ctx.fillStyle = "hsla(" + hue + ",90%,39%,0.8)";
					var dotDotDot = "..."
					if(ds.label.length <= 10) {
						dotDotDot = "";	
					}
			    	var label = ds.label.substr(0,10) + dotDotDot;
			    	var meta = chartInstance.controller.getDatasetMeta(index);
			    	var len = meta.data.length-1;
			    	//console.log(ds, meta.data[len]._model);    
			    	var xOffset = meta.data[len]._model.x+10;
			    	var yOffset = meta.data[len]._model.y+5;
			    	ctx.fillText(label, xOffset, yOffset);
					i++;
				});
				ctx.restore();
			}
			
			function removeLine(county,state) {
				for(var i = 0; i < currentlyShowing.length; i++) {
					if (currentlyShowing[i].county == county && currentlyShowing[i].state == state) {
						currentlyShowing.splice(i,1);
						redrawChart();
						break;
					}
				}
			}
			
			function removeState(state) {
				for(var i = 0; i < currentlyShowingStates.length; i++) {
					if (currentlyShowingStates[i] == state) {
						currentlyShowingStates.splice(i,1);
						redrawChart();
						break;
					}
				}
			}
			
			function specialArray(array) { //Deals with two variables: (1) Whether we are getting all data or data after 5 cases, and (2) the type of data to show.
				var newArray = [];
				
				switch(document.getElementById("dataSelect").value) {
					case "DaysSince5":
						var startIndex = 0;
						for(var i = 0; i < array.length; i++) {
							startIndex = i;
							if(array[i] >= 5) {
								break;
							} 
						}
						newArray = array.slice(startIndex);
						break;
					case "All":
						newArray = array;
						break;
						
				}
				
				switch(document.getElementById("dataType").value) {
					case "TotalCases":
						break;
					case "NewDay":
						newArray = getDiffs(newArray);
						break;
					case "New7Day":
						newArray = get7DA(getDiffs(newArray));
						break;
					case "PercentDay":
						newArray = getPercs(newArray);
						break;
					case "Percent7DA":
						newArray = get7DA(getPercs(newArray));
						break;
						
				}
				
				return newArray;	
			}
			
			function getPercs(newArray) {
				var differenceArray = [];
				for(var i = 0; i < newArray.length; i++) {
					if(i > 0) {
						var last = newArray[i - 1];
						if(last != 0) {
							differenceArray[i] = Math.round((newArray[i] - last) / last * 10000) / 100;
						} else {
							differenceArray[i] = 0;	
						}
					} else {
						differenceArray[0] = 0;	
					}
				}
				return differenceArray;
			}
				
			function getDiffs(newArray) {
				var differenceArray = [];
				for(var i = 0; i < newArray.length; i++) {
					if(i > 0) {
						differenceArray[i] = newArray[i] - newArray[i - 1];
					} else {
						differenceArray[0] = newArray[0];	
					}
				}
				return differenceArray;
			}
			
			function get7DA(array) {
				var sdAVGarray = [];
				for(var i = 0; i < array.length; i++) {
					if(i < 6) {
						var sum = 0;
						for(var j = 0; j <= i; j++) {
							sum += Number(array[j]);
						}
						var avg = sum / (i + 1);
						sdAVGarray[i] = Math.round(avg * 100) / 100;
					} else {
						var sum = 0;
						for(var j = 0; j < 7; j++) {
							sum += Number(array[i - j]);
						}
						var avg = sum / 7;
						sdAVGarray[i] = Math.round(avg * 100) / 100;
					}
				}
				return sdAVGarray;
			}
			
			function getDatasets() {
				var datasets = [];
				var showingArray = (currentType == "county") ? currentlyShowing : currentlyShowingStates;
				for(var i = 0; i < showingArray.length; i++) {
					var crtObj = showingArray[i]; 
					var hue = Math.round((hueMultiplier * i) % 360);
					//console.log(hue);
					var arrayToUse;
					var label;
					if(currentType == "county") {
						var county = crtObj.county;
						var state = crtObj.state;
						arrayToUse = countyByState[state][county];
						label = county + ", " + state;
					} else {
						var state = crtObj;
						label = state;
						arrayToUse = stateData[state];
					}
					//console.log(arrayToUse);
					datasets[i] = {
						label:	label,
						//use if for states
						data: specialArray(arrayToUse),
						backgroundColor: "rgba(0, 0, 0, 0)",
						borderColor: "hsla(" + hue + ",90%,39%,0.7)"
					}
				}
				
				return datasets;
			}
			
			function getLabels() { //Deals with one variable: (1) Whether we are getting all data or data after 5 cases
				var labels = [];
				var maxLength = 0;
				var showingArray = (currentType == "county") ? currentlyShowing : currentlyShowingStates;
				for(var i = 0; i < showingArray.length; i++) {
					var crtObj = showingArray[i];
					var data;
					if(currentType == "county") {
						var county = crtObj.county;
						var state = crtObj.state;
						data = countyByState[state][county];
					} else {
						data = stateData[crtObj];	
					}
					
					//console.log(data);
					
					var startIndex; 
					for(var j = 0; j < data.length; j++) {
						if(data[j] >= 5) {
							startIndex = j;
							break;
						}
					}
					var testMax = data.slice(startIndex).length;
					if(testMax > maxLength) {
						maxLength = testMax;
						
					}
													   
				}
				
				switch(document.getElementById("dataSelect").value) {
					case "DaysSince5":
						for(var i = 0; i < maxLength; i++) {
							labels[i] = i + " days";
						}
						break;
					case "All":
						labels = dayLabels;
						break;
				}
				return labels;
			}
			
			function redrawChart() {
				var ctx = document.getElementById("myChart");
				if(myLineChart) { myLineChart.destroy(); }
				myLineChart = new Chart(ctx, {
				    type: 'line',
				    data: {
						labels: getLabels(),
						datasets: getDatasets()
					},
					options: {
						scales: {
							yAxes: [{
								type: document.getElementById("graphType").value
							}]
						},
						legend: {
							display: false
						},
						tooltips: {
							mode: "index",
							intersect: false
						},
						maintainAspectRatio: false,
						layout: {
							padding: {
								right: 125,
								top: 10,
								bottom: 10
							}
						}
					}
				});	
				showLegend();
			}
			
			function changeCounty() {
				
				var state = document.getElementById("state").value;
				var county = document.getElementById("county").value;
				pushLine(county,state);
				redrawChart();
				//myLineChart.canvas.parentNode.style.height = "50px";
			}
			
			function deleteChildren(elementId) {
                var element = document.getElementById(elementId);
                if (element) {
                    while (element.firstChild) {
                        element.removeChild(element.firstChild);
                    }
                }
            }
			
			function getTopInState() {
				currentlyShowing = [];
				var lastDataPoints = [];
				var state = document.getElementById("state").value;
				var countyNames = Object.getOwnPropertyNames(countyByState[state]);
				console.log("Note: Top data for states will not include counties where yesterday's cases are less than 5.");
				for (var i = 0; i < countyNames.length; i++) {
					var raw = countyByState[state][countyNames[i]];
					var data = specialArray(raw);
					var lastValue = 0;
					if(specialArray && data[data.length - 1]) {
						lastValue = data[data.length - 1];
					}
					if(raw[raw.length - 1] < 5) {
						lastValue = 0;	
					}
					lastDataPoints[i] = {
						value: lastValue,
						state: state,
						county: countyNames[i]
					}
				}
				
				lastDataPoints.sort(function(a,b){ return reverse * (b.value - a.value); }); //note: this is a reverse (high to low) sort.
				
				for (var i = 0; i < maxToShow; i++) {
					if(lastDataPoints[i]) {
						currentlyShowing[i] = {
							county: lastDataPoints[i].county,
							state: lastDataPoints[i].state
						}
					}
				}
				
				redrawChart();
			}
			
			function getTopInUS() {
				currentlyShowing = [];
				var lastDataPoints = [];
				var stateNames = Object.getOwnPropertyNames(countyByState);
				var allIndex = 0;
				console.log("Note: Top data for US will not include counties where yesterday's cases are less than 10.");
				
				if(currentType == "county") {
				
					for(var i = 0; i < stateNames.length; i++) {
						var state = stateNames[i];
						var countyNames = Object.getOwnPropertyNames(countyByState[state]);
						for (var j = 0; j < countyNames.length; j++) {
							var raw = countyByState[state][countyNames[j]];
							var data = specialArray(raw);
							var lastValue = 0;
							if(data && data[data.length - 1]) {
								lastValue = data[data.length - 1];
							}
							if(raw[raw.length - 1] < 10) {
								lastValue = 0;	
							}
							lastDataPoints[allIndex] = {
								value: lastValue,
								state: state,
								county: countyNames[j]
							}
							allIndex++
						}
					}
					
				} else {
					for(var i = 0; i < stateNames.length; i++) {
						var state = stateNames[i];
						var raw = stateData[state];
						var data = specialArray(raw);
						var lastValue = 0;
						if(data && data[data.length - 1]) {
							lastValue = data[data.length - 1];
						}
						if(raw[raw.length - 1] < 10) {
							lastValue = 0;	
						}
						lastDataPoints[allIndex] = {
							value: lastValue,
							state: state
						}
						allIndex++
					}	
				}
					
				lastDataPoints.sort(function(a,b){ return reverse * (b.value - a.value); }); //note: this is a reverse (high to low) sort.
				
				for (var i = 0; i < maxToShow; i++) {
					
					//console.log(county + ", " + state);
					if(lastDataPoints[i] && currentType == "county") {
						var county = lastDataPoints[i].county;
						var state = lastDataPoints[i].state;
						currentlyShowing[i] = {
							county: county,
							state: state
						}
					} else if(lastDataPoints[i]) {
						var state = lastDataPoints[i].state;
						currentlyShowingStates[i] = state;
					}
				}
				
				redrawChart();
			}
			
			function clearData() {
				if(currentType == "county") {
					currentlyShowing = [];
				} else {
					currentlyShowingStates = [];	
				}
				redrawChart();
			}
			
			function pushState(state) {
				var hasMatch = false;
				for(var i = 0; i < currentlyShowingStates.length; i++) {
					if(currentlyShowingStates[i] == state) {
						hasMatch = true;
						break;
					}
				}
				if(!hasMatch) {
					currentlyShowingStates.push(state);
				}
			}	
			
			function changeStateCounty() {
				currentType = document.getElementById("stateCounty").value;
				if(currentType == "state") {
					pushState(document.getElementById("state").value);
				}	
				SCDisable();
				redrawChart();
			}
			
			function SCDisable() {
				var disabled = (currentType == "state") ? true : false;
				document.getElementById("county").disabled = disabled;
				document.getElementById("gts").disabled = disabled;
				document.getElementById("gis").disabled = disabled;
			}
			
			function customRank() {
				document.getElementById("customOverlay").style.display = "block";
				document.getElementById("crby").innerText = document.getElementById("stateCounty").value;
			}
			
			function customRankGo(type) {
				var funcName;
				if(type == "US") { funcName = getTopInUS } else { funcName = getTopInState }
				var rev = document.getElementById("hilo").value;
				var num = document.getElementById("num").value;
				if(num) {
					doCustomRank(rev,num,funcName);
					closeCustom();
				}
			}
			
			function closeCustom() {
				document.getElementById("customOverlay").style.display = "none";
			}
			
			function doCustomRank(rev,num,funcName) {
				reverse = rev;
				maxToShow = num;
				funcName();
				reverse = 1;
				maxToShow = 20;
			}
			
			function showAll(state,county) {
				var outputSpace = document.getElementById("showAllOutput");
				deleteChildren("showAllOutput");
				var title = document.getElementById("allTitle");
				var label = "Showing all data for ";
				label += county ? county + ", " + state : state;
				title.innerText = label;
				var arrayToUse = county ? countyByState[state][county] : stateData[state];
				var deltaArray = getDiffs(arrayToUse);
				var deltaAvgArray = get7DA(deltaArray);
				var percArray = getPercs(arrayToUse);
				var percArrayAvg = get7DA(percArray);
				var table = document.createElement("table");
				table.classList.add("myTable");
				var headerRow = document.createElement("tr");
				var headers = ["Date","Total","\u0394Today","%Growth","\u0394 (7d Avg)","%Growth (7d Avg)"];
				var tdItems = [dayLabels,arrayToUse,deltaArray,percArray,deltaAvgArray,percArrayAvg];
				for(var j = 0; j < headers.length; j++) {
					var th = document.createElement("th");
					th.innerText = headers[j];
					headerRow.appendChild(th);
				}
				table.appendChild(headerRow);
				for (var i = (arrayToUse.length - 1); i >= 0; i--) {
					var row = document.createElement("tr");
					for(var j = 0; j < headers.length; j++) {
						var td = document.createElement("td");
						if(j == 0) {
							td.innerHTML = "<b><i>" + dayLabels[i] + "</b></i>";
						} else { 
							var suffix;
							if(j == 1 || j == 2 || j == 4) {
								suffix = "";
							} else {
								suffix = "%";	
							}
							if(j > 3) {
								suffix += " /day";	
							}
							var plusMinus = "+";
							if(tdItems[j][i] < 0) { plusMinus = "" }
							td.innerText = plusMinus + tdItems[j][i] + suffix; 
						}
						td.classList.add("right");
						row.appendChild(td);
					}
					table.appendChild(row);
				}
				outputSpace.appendChild(table);
				var bigDiv = document.getElementById("allOutput")
				bigDiv.style.display = "inline-block";
				bigDiv.requestFullscreen();
				
			}
			
			function closeData() {
				document.getElementById('allOutput').style.display = 'none';
				document.exitFullscreen();
			}
			
        </script>     
		
		<style>
			#allOutput {
				background-color: white;	
				overflow: scroll;
			}
			
			#outputArea {
				height: calc(25vh - 10px);
				width: calc(100vw - 10px);
				background-color: white;
				overflow: scroll;
			}
			
		 	#status {
				width: 50%;	
			}
			
			#topBar {
				height: calc(5vw + 46px);
				width: calc(100vw - 10px);
				padding: 5px;
			}
			
			#chartSpace {
				width: 99vw; 
				height: calc(75vh - 5vw - 46px);
				background-color: white;
			}
			
			#output {
				width: calc(100% - 10px);
				padding: 5px;
			}
			
			body {
				margin: 0px;
				padding: 0px;
			}
			
			
				#status {
					width: calc(60% - 15px);	
				}
				select {
					width: calc(20% - 2.666px);
				}
				.firstRow {
					width: calc(20% - 20px);
				}
				.sndRowBtn {
					width: calc(20% - 20px);	
				}
			
			@media (orientation: portrait) {
				#status {
					display: none;	
				}
				.firstRow {
					width: calc(50% - 13px);
				}
			}
			
			#topBar :disabled {
				display: inline-block;
  				background-color: white;
  				border: 2px solid gray;
  				color: gray;
				padding: 0px 10px;
  				text-decoration: none;
  				display: inline-block;
  				font-size: 1.8vw;
				font-family: sans-serif;
				margin: 2px;
			}
			
			.top {
				display: inline-block;
  				background-color: white;
  				border: 2px solid black;
  				color: black;
				padding: 0px 10px;
  				text-decoration: none;
  				display: inline-block;
  				font-size: 1.8vw;
				font-family: sans-serif;
				margin: 2px;
			}
			
			
			
			.top:hover {
				background-color: #dddddd;
				transition: 0.1s;
			}
			
			.top:disabled:hover {
				background-color: #ffffff;
			}
			
			.color {
				width: 20px;
				height: 20px;
				border-width: 0px;
				margin-top: 4px;
			}
			
			.legend {
				display: flex;	
			}
			
			.legendLabel {
				padding-left: 10px;	
				display: block;
				width: 255px;
			}
			
			/*:not(:fullscreen) .fsOnly {
				display: none;	
			}
			
			:not(:fullscreen) .fsNot {
				display: inline-block;	
			}*/
			
			.fsOnly {
				display: none;	
			}
			
			.fsNot {
				display: inline-block;	
			}
			
			:fullscreen .fsOnly {
				display: inline-block;
			}
			
			:fullscreen .fsNot {
				display: none;	
			}
			
			table, td, th, tr {
				border: 1px solid #eeeeee;
				border-collapse: collapse;
				padding: 5px
			}
			
			.right {
				text-align: right;
			}
			
			#customOverlay {
				background-color: rgba(100,100,100,0.5);
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				width: 100%;
				height: 100%;
			}
			
			#windowBox {
				position: absolute;
				top: calc(50% - 15vw - 5px);
				left: calc(50% - 30vw - 5px);
				background-color: white;
				height: 30vw;
				width: 60vw;
				padding: 5px;
				box-shadow: 0px 5px 15px gray;
				border-radius: 5px;
				text-align: center;
			}
			
			#num {
				width: 5vw;	
			}
			#hilo {
				width: 15vw;	
			}
			
			#verticalAlign {
				line-height: calc((30vw - 10px) / 3)	
			}
		</style>
		
    </head>

    <body onload="bodyLoaded()">
		<div id="topBar">
			<input type="text" class="top" readonly id="status" value="Importing data from JHU dataset. Please wait..."/>
			<select id="state" class="firstRow top" onchange="changeState()" disabled>
				<option disabled selected>Please wait...</option>
			</select>
			<select id="county" class="firstRow top" onchange="changeCounty()" disabled>
				<option disabled selected>Select a state first.</option>
			</select><br/>
			<select id="dataSelect" class="top" onchange="redrawChart()">
				<option value="DaysSince5" selected>Days Since 5 Cases</option>
				<option value="All">All</option>
			</select>	
			<select id="dataType" class="top" onchange="redrawChart()">
				<option value="TotalCases" selected>Total Cases</option>
				<option value="NewDay">New Cases / Day</option>
				<option value="New7Day">New Cases (7 Day Avg)</option>
				<option value="PercentDay">% Growth</option>
				<option value="Percent7DA">% Growth (7 Day Avg)</option>
			</select>
			<select class="top" id="graphType" onchange="redrawChart()">
				<option value="linear" selected>Linear</option>
				<option value="logarithmic">Logarithmic</option>
			</select>	
			<button id="gts" onclick="getTopInState()" class="sndRowBtn top">State Top 20</button>
			<button onclick="getTopInUS()" class="sndRowBtn top">US Top 20</button>
			<select id="stateCounty" onchange="changeStateCounty()" class="top">
				<option value="county" selected>By County</option>
				<option value="state">By State</option>
			</select>
			<button onclick="customRank()" class="top" >Custom Rank</button>
			<button onclick="clearData()" class="top" >Clear</button>
			<button onclick="window.location.reload();" class="top" >Reset</button>
		</div>
		<div id="chartSpace">
			<button onclick="document.getElementById('chartSpace').requestFullscreen()" class="fsNot">Expand Chart (full screen)</button>
			<button onclick="document.exitFullscreen()" class="fsOnly">Close full screen</button>
			<canvas id="myChart">
			</canvas>
		</div>
		<div id="outputArea">
			<button onclick="document.getElementById('outputArea').requestFullscreen()" class="fsNot">Expand List (full screen)</button>
			<button onclick="document.exitFullscreen()" class="fsOnly">Close full screen</button>
			<div id="output"></div>
		</div>
		<div id="customOverlay" hidden>
			<div id="windowBox">
				<div id="verticalAlign">
					CUSTOM RANKING by <label id="crby"></label><br/>
					Get 
					<select id="hilo">
						<option value=1 selected>Highest</option>
						<option value=-1>Lowest</option>
					</select>
					<input id="num" type="number" />
					locations<br/>
					<button id="gis" onclick="customRankGo('state')">Go (in state)</button>
					<button onclick="customRankGo('US')">Go (in US)</button>
					<button onclick="closeCustom()">Cancel</button>
				</div>
			</div>
		</div>
		<div id="allOutput" class="fsOnly">
			<button onclick="closeData()">Close full screen</button>
			<br/><br/><label id="allTitle"></label><br/><br/>
			<div id="showAllOutput"></div>
		</div>
    </body>

</html>
